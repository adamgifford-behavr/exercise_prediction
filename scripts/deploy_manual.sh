#!/usr/bin/env bash

AWS_REGION="us-east-1"

# Dynamically generated by TF
export MODEL_BUCKET_PROD="stg-agifford-mlflow-artifacts-remote-exercise-prediction"
export PREDICTIONS_STREAM_NAME="stg_predictions_stream-exercise-prediction"
export LAMBDA_FUNCTION="stg_prediction_lambda_exercise-prediction"

# Model artifacts bucket from your stand-alone runs of modeling
export MODEL_BUCKET_DEV="agifford-mlflow-artifacts-remote"

# Get latest RUN_ID from latest S3 partition.
# NOT FOR PRODUCTION!
# In practice, this is generally picked up from your experiment tracking tool such as MLflow or DVC
export RUN_ID="85412c4643564a4f8a6b3d8f0130216a"
export EXPERIMENT_ID="4"

# NOT FOR PRODUCTION!
# Just mocking the artifacts from training process in the Prod env
aws s3 sync s3://${MODEL_BUCKET_DEV} s3://${MODEL_BUCKET_PROD}

# Set new var RUN_ID in existing set of vars.
variables="{PREDICTIONS_STREAM_NAME=${PREDICTIONS_STREAM_NAME}, MODEL_BUCKET=${MODEL_BUCKET_PROD}, RUN_ID=${RUN_ID}, EXPERIMENT_ID=${EXPERIMENT_ID}}"

# https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html
aws lambda update-function-configuration --function-name ${LAMBDA_FUNCTION} --environment "Variables=${variables}"